# 企微同步Notion系统架构与流程图

## 系统概述
基于Cloudflare Workers的小红书/抖音内容解析与Notion同步系统，支持图片、视频、Live图等多种内容类型的自动化处理。

## 核心代码文件架构

### 🚀 主入口层
- **`src/index.ts`** - 主应用入口，HTTP路由处理
  - 定义所有API端点 (`/parse`, `/sync-from-text`, `/health` 等)
  - 处理CORS跨域请求
  - 管理员权限验证
  - 错误处理和响应格式化

### 🔍 内容解析层
- **`src/xiaohongshuParser.ts`** - 小红书内容解析器
  - 提取标题、作者、内容、图片、视频
  - 使用og:image标签提取无水印图片
  - 支持Live图、图文、视频等内容类型识别
  - 桌面端User-Agent模拟，绕过移动端限制

- **`src/douyinParser.ts`** - 抖音内容解析器
  - 解析抖音视频和图集内容
  - 提取无水印视频链接
  - 支持Live图和普通视频识别
  - API接口调用和HTML解析双重策略

### 🎬 媒体处理层
- **`src/media.ts`** - 媒体文件处理核心
  - 下载原始媒体文件（图片/视频）
  - 智能存储选择：图床 vs R2存储
  - 文件格式优化（JPEG优先，避免WebP）
  - 并发处理和超时控制
  - 验证处理后链接的有效性

- **`src/imageHost.ts`** - 图床服务接口
  - TG-Image图床API集成
  - 令牌管理和自动刷新
  - 文件上传和URL提取
  - 错误重试和降级处理

### 📝 Notion集成层
- **`src/notionSync.ts`** - Notion同步核心
  - 创建Notion页面和数据库记录
  - 设置页面封面和媒体属性
  - 智能标签生成（平台、内容类型、Live图等）
  - 批量同步和错误处理

### ⚙️ 配置与工具层
- **`src/config.ts`** - 系统配置管理
  - R2存储配置（访问密钥、存储桶）
  - Notion API配置（数据库ID、属性映射）
  - 图床服务配置（域名、认证信息）
  - KV缓存配置

- **`src/utils.ts`** - 通用工具函数
  - 链接提取（小红书/抖音）
  - 网络请求封装（超时控制）
  - 响应格式化和错误处理
  - 类型守卫函数

## 完整处理流程

### 1️⃣ 请求接收阶段
```
用户请求 → index.ts → 路由分发
    ↓
验证管理员权限 → 提取链接 → 确定平台类型
```

### 2️⃣ 内容解析阶段
```
小红书链接 → xiaohongshuParser.ts
    ↓
- 发送HTTP请求（桌面端User-Agent）
- 解析HTML内容
- 提取标题、作者、内容
- 提取og:image无水印图片
- 提取视频链接
- 判断内容类型（图文/视频/Live图）

抖音链接 → douyinParser.ts
    ↓
- API接口调用
- 提取视频/图集内容
- 无水印链接处理
- Live图识别
```

### 3️⃣ 媒体处理阶段
```
原始媒体链接 → media.ts
    ↓
并发下载所有媒体文件
    ↓
文件大小判断 → 存储方式选择
    ↓
小文件(<19MB) → imageHost.ts → TG-Image图床
大文件(≥19MB) → R2存储
    ↓
验证上传结果 → 确保不是原始链接
```

### 4️⃣ Notion同步阶段
```
处理后的数据 → notionSync.ts
    ↓
创建Notion页面
    ↓
设置页面属性：
- 标题、作者、原帖链接
- 智能标签（平台+内容类型）
- 创建时间
    ↓
添加页面内容：
- 图片块（图文笔记）
- 视频块（视频笔记）
- Live图特殊处理
    ↓
设置页面封面
    ↓
完成同步
```

## 关键特性

### 🔄 智能处理策略
- **同步处理**: 媒体文件处理完成后再同步到Notion
- **验证机制**: 确保处理后的链接不是原始平台链接
- **降级处理**: 图床失败时自动切换到R2存储
- **重试机制**: 网络请求和文件上传的自动重试

### 🏷️ 智能标签系统
- **平台标签**: 自动识别小红书/抖音
- **内容类型**: 图文/视频/实况图片
- **自定义标签**: 支持用户添加额外标签

### 📱 多内容类型支持
- **图文笔记**: 多图片展示，第一张作为封面
- **视频笔记**: 视频链接+封面图片
- **Live图**: 视频+图片组合，特殊标识

### 🔒 安全与权限
- **管理员验证**: API调用需要管理员密钥
- **CORS支持**: 跨域请求处理
- **错误隔离**: 完善的错误处理和日志记录

## 部署配置

### Cloudflare Workers绑定
- **KV存储**: 缓存解析结果
- **R2存储**: 大文件存储
- **环境变量**: 密钥和配置管理

### 外部服务集成
- **TG-Image图床**: 小文件快速存储
- **Notion API**: 页面创建和内容同步
- **小红书/抖音**: 内容源平台

---

# 程序执行顺序图

## 📋 完整操作流程图

### 1️⃣ 请求入口阶段
```
HTTP请求 → index.ts:fetch()
    ↓
CORS预检处理 → OPTIONS请求直接返回
    ↓
路由匹配 → Router.handle()
    ↓
端点分发:
├── GET /health → 健康检查
├── GET /parse → 解析内容（异步处理）
├── POST /extract-link → 提取链接
├── GET /sync-to-notion → 同步到Notion（已废弃）
├── POST /sync-from-text → 从文本同步（主要端点）
└── GET /admin/refresh-token → 刷新图床令牌
```

### 2️⃣ 权限验证阶段
```
POST /sync-from-text → validateAdminKey()
    ↓
检查请求头Content-Type:
├── application/json → 解析JSON请求体
└── multipart/form-data → 解析表单数据
    ↓
提取参数:
├── text: 包含链接的文本
├── key: 管理员密钥
└── tags: 自定义标签（可选）
    ↓
验证管理员密钥 → env.ADMIN_KEY
    ↓
成功 → 继续处理
失败 → 返回401未授权
```

### 3️⃣ 链接提取阶段
```
文本内容 → utils.ts:extractXiaohongshuLink()
    ↓
正则匹配模式:
├── /(https?:\/\/xhslink\.com\/[^\s,，。；;!！?？\"\'\"\"\'\'\s]*)/i
├── /(https?:\/\/xhslink\.com\/[a-zA-Z0-9\/\._\-]+)/i
├── /(https?:\/\/(?:www\.)?xiaohongshu\.com\/[^\s,，。；;!！?？\"\'\"\"\'\'\s]*)/i
└── /https?:\/\/xhslink\.com\/[a-zA-Z0-9\/\._\-]+/i
    ↓
找到小红书链接 → 继续小红书解析
    ↓
未找到 → utils.ts:extractDouyinLink()
    ↓
抖音链接匹配模式:
├── /(https?:\/\/(?:www\.)?douyin\.com\/[^\s,，。；;!！?？\"\'\"\"\'\'\s]*)/i
├── /(https?:\/\/(?:www\.)?douyin\.com\/[a-zA-Z0-9\/\._\-]+)/i
├── /(https?:\/\/v\.douyin\.com\/[^\s,，。；;!！?？\"\'\"\"\'\'\s]*)/i
└── /https?:\/\/(?:www\.|v\.)?douyin\.com\/[a-zA-Z0-9\/\._\-]+/i
    ↓
找到抖音链接 → 继续抖音解析
    ↓
都未找到 → 返回400错误
```

### 4️⃣ 内容解析阶段

#### 4.1 小红书解析流程
```
小红书链接 → xiaohongshuParser.ts:parseXiaohongshu()
    ↓
设置调试模式 → setDebugMode(true)
    ↓
网络请求配置:
├── User-Agent: 桌面端浏览器标识
├── Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
├── Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
└── Cache-Control: no-cache
    ↓
发送HTTP请求 → fetchWithRetry()
    ↓
重试机制（最多2次）:
├── 超时控制: 15秒
├── 重试延迟: 1秒递增
└── 错误处理: 网络异常、HTTP错误
    ↓
获取HTML内容 → response.text()
    ↓
内容验证:
├── 检查错误页面: 'internal error', '验证码', 'captcha'
└── 验证内容长度
    ↓
信息提取:
├── extractTitle() → 标题提取
├── extractAuthor() → 作者提取
├── extractContent() → 正文提取
├── extractNoteId() → 笔记ID提取
├── extractImages() → 图片提取（关键）
└── extractVideos() → 视频提取
```

#### 4.2 图片提取详细流程（文件格式优化核心）
```
extractImages() → PATTERNS.ogImage正则匹配
    ↓
正则表达式: /<meta[^>]*name=["']og:image["'][^>]*content=["']([^"']+)["'][^>]*>/gi
    ↓
遍历所有匹配结果:
├── 提取content属性值
├── cleanUrl() → 清理转义字符
├── 验证URL有效性
└── 添加到图片数组
    ↓
图片URL示例:
├── http://sns-webpic-qc.xhscdn.com/.../1040g0k031ij46on0no005pva7k3jjnig79ulmr8!nd_dft_wgth_jpg_3
└── 无水印、高质量JPEG格式
    ↓
返回图片URL数组
```

#### 4.3 抖音解析流程
```
抖音链接 → douyinParser.ts:parseDouyin()
    ↓
API请求策略:
├── 移动端API: https://m.douyin.com/web/api/v2/aweme/iteminfo/
└── 桌面端API: https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/
    ↓
图片格式优化（关键）:
├── 遍历item.images数组
├── 检查img.url_list中的所有URL
├── 优先选择JPEG格式: url.includes('.jpeg') || url.includes('.jpg')
├── 降级选择: 如果无JPEG则使用第一个URL
└── 记录格式选择日志
    ↓
封面选择优化:
├── selectBestCoverUrl() → 优先JPEG格式
├── 避免WebP格式
└── 确保Notion兼容性
```

### 5️⃣ 媒体处理阶段（文件格式优化实现）

#### 5.1 媒体处理入口
```
解析数据 → media.ts:handleMediaFiles()
    ↓
设置图床环境 → imageHostService.setEnv(env)
    ↓
处理封面图片:
├── 检查parsedData.cover存在
├── 生成唯一键: cover/${noteId}_cover
└── 调用processMediaFile()
    ↓
处理图片数组:
├── 并发处理: Promise.all()
├── 超时控制: 每张图片30秒，总计不超过5分钟
├── 验证机制: 确保不是原始xhscdn.com链接
└── 错误处理: 任一图片失败则整体失败
    ↓
处理视频文件:
├── 检查parsedData.video存在
├── 生成唯一键: video/${noteId}_video
└── 调用processMediaFile()
```

#### 5.2 单文件处理流程
```
processMediaFile() → 文件格式优化核心
    ↓
输入类型判断:
├── ArrayBuffer/Uint8Array → 直接处理缓存数据
└── URL字符串 → 下载后处理
    ↓
URL下载流程:
├── 发送HTTP请求 → fetch(url)
├── 获取Content-Type → response.headers.get('content-type')
├── 下载文件数据 → response.arrayBuffer()
└── 记录文件大小
    ↓
文件格式处理:
├── 视频文件 → 强制.mp4扩展名
├── 图片文件 → getFileExtension(url)提取原始扩展名
├── Content-Type映射 → CONTENT_TYPE_MAP查找
└── 无需WebP转换（已在URL选择阶段优先选择JPEG）
    ↓
存储方式选择:
├── 文件大小 < 19MB → 图床存储
├── 文件大小 ≥ 19MB → R2存储
├── forceImageHost=true → 强制图床
└── forceR2=true → 强制R2
```

#### 5.3 图床上传流程
```
imageHostService.uploadFile() → 图床格式优化
    ↓
文件准备:
├── 创建File对象 → new File([buffer], fileName, {type: contentType})
├── 准备FormData → formData.append('file', file)
└── 设置请求头 → Authorization: Bearer ${token}
    ↓
上传请求:
├── POST请求 → config.UPLOAD_URL
├── 超时控制: 30秒
├── 错误重试: 图床失败→R2备选
└── 响应解析: JSON格式
    ↓
URL提取优化:
├── 标准格式: [{src: "/file/fileId.extension"}]
├── 对象格式: {src: "/file/fileId.extension"}
├── 嵌套格式: {data: {url: "..."}}
└── 降级处理: 构造默认URL
    ↓
WebP格式特殊处理:
├── 检测封面图片: fileName.includes('cover')
├── 检测WebP格式: ext === 'webp'
├── 强制转换: webp → jpg
└── 记录转换日志
```

#### 5.4 R2存储流程
```
uploadToR2() → 大文件存储
    ↓
S3客户端配置:
├── endpoint: R2_CONFIG.S3_API_URL
├── credentials: ACCESS_KEY_ID + SECRET_ACCESS_KEY
├── region: auto
└── forcePathStyle: true
    ↓
上传操作:
├── PutObjectCommand → S3兼容API
├── Bucket: R2_CONFIG.BUCKET_NAME
├── Key: 文件路径
├── Body: 文件数据
├── ContentType: MIME类型
└── 超时控制: 60秒
    ↓
URL生成:
├── 公共访问URL: R2_CONFIG.PUBLIC_URL
├── 完整路径: ${PUBLIC_URL}/${fileName}
└── 返回可访问链接
```

### 6️⃣ Notion同步阶段

#### 6.1 页面创建流程
```
notionSync.ts:syncToNotion() → Notion集成
    ↓
数据预处理:
├── 生成智能标签 → generateSystemTags()
├── 合并自定义标签 → mergeAllTags()
├── 确定内容类型 → determineContentType()
└── 验证必要字段
    ↓
页面属性构建:
├── 标题 → parsedData.title
├── 作者 → parsedData.author.name
├── 原帖链接 → parsedData.original_url
├── 标签 → 智能标签数组
└── 创建时间 → 当前时间戳
    ↓
页面内容构建:
├── 正文段落 → parsedData.content
├── 图片块 → 处理后的图片URL
├── 视频块 → 处理后的视频URL
└── Live图特殊处理
```

#### 6.2 媒体内容添加
```
addMediaToPage() → 媒体属性设置
    ↓
图片处理（图文笔记）:
├── 验证URL有效性 → isValidImageUrl()
├── 创建图片块 → image block type
├── 设置外部URL → external.url
└── 添加到页面内容
    ↓
视频处理:
├── 验证视频URL
├── 创建视频块 → video block type
├── 设置外部URL → external.url
└── 添加到页面内容
    ↓
封面设置:
├── 检查parsedData.cover存在
├── 验证URL格式 → startsWith('http')
├── 设置页面封面 → cover.external.url
└── 错误处理: 失败不影响主流程
```

### 7️⃣ 响应返回阶段
```
同步完成 → 构建响应数据
    ↓
成功响应:
├── message: "同步到 Notion 成功"
├── extracted_link: 提取的链接
├── platform: 平台类型（小红书/抖音）
├── notion_page_id: Notion页面ID
├── notion_page_url: Notion页面URL
├── applied_tags: 应用的标签数组
├── video_processed: 视频处理状态
├── video_url: 处理后的视频URL
└── async_processing: false（同步处理）
    ↓
错误响应:
├── error: true
├── message: 错误描述
├── details: 详细错误信息
├── url: 相关URL
└── timestamp: 错误时间戳
    ↓
添加CORS头 → 支持跨域访问
    ↓
返回HTTP响应
```

## 🔧 文件格式优化工作原理

### 格式优先级策略
1. **源头优化**: 在解析阶段就优先选择JPEG格式URL
2. **智能降级**: JPEG不可用时选择其他格式
3. **强制转换**: WebP封面图片强制转为JPG
4. **兼容性保证**: 确保Notion能正常显示

### 关键优化点
- **抖音图片**: 优先选择`.jpeg`或`.jpg`结尾的URL
- **小红书图片**: 通过og:image获取高质量JPEG
- **封面处理**: WebP格式自动转换为JPG
- **文件扩展名**: 根据Content-Type智能映射

### 性能优化
- **并发处理**: 多个图片同时下载上传
- **超时控制**: 防止单个文件阻塞整个流程
- **错误隔离**: 单个文件失败不影响其他文件
- **缓存机制**: KV存储避免重复处理